---
title: OneDriveのディレクトリからサムネイル画像URLを一括で取得する
date: 2023-01-02
thumbnail: https://refetch.xar.sh/dsm01pap006files.storage.live.com/y4msP8-EGj-BX3c9VI5lvQJ9W9qm7kbTf7RyCwGQ21QH28nVyRvx4O5gILEjXkPp_C7KfEYvhLPmQkcCdeaNUlWrh1n85vj__B9mzFCXQpXoKj4slykF0Ko0Gz0htdmZrCn8GOKui0w-nXKMSKdQRL9_HMAE5-5E3mff0BihBWlL07bUCDjGvizmVz0DBJj7l6b?width=1024&height=768&cropmode=none
---

ブログの記事を書くというのはマジでめんどくさく、しかししばらく経ってから読み返すと案外面白いという唯一の利点のために10年くらい投稿している。めんどくささをできるだけ排除し、少しでも楽をするためにこまごまとした工夫はたくさんある。コマンドひとつでfrontmatter付きの新しいMarkdownファイルを作れるようにMakefileを書いたり、`git push`したら勝手にビルドして公開するようにしたり、404を検知できるようにしたりと、記事投稿やサイト運用のハードルを定期的に取り除きつづけないとわたしはめんどくささに負けてブログを放置してしまうのだ。

旅行系の記事に貼り付ける画像を用意するというのもまたとんでもなくめんどくさい。たくさんある写真から載せたい画像を選び、記事中に貼れるサイズに縮小し、固定URLを発行し、Markdown形式で記事に貼り付ける、という手順を画像の枚数だけ繰り替えす。これがあまりにも面倒なので、いまは全ての画像のURLを発行して記事中に一括して貼り付け、記事を書きながら不要なものをごりごり削るというスタイルに落ち着いた。

SmugMugをつかっていたときは、縮小された画像への直リンURLが管理者にとって予測可能な形をとっていたためエディタの置換機能を使えばまとめてリンクを作ることができた。しかし[OneDriveに移行してから](/post/1667378672/)はそうもいかない。OneDriveではサイトに埋め込める形式のURL発行はサーバーへのリクエストによってランダムなURLとして生成されるからだ。しかたないのでAPIを使って縮小画像URLを生成する短いスクリプトを書いた。

OneDriveにかぎらずMicrosoft社のWebサービスはMicrosoft Graph APIとよばれる統合された単一のエンドポイントから操作できる。Azure Active Directoryでアプリケーションとして登録すればサービスプリンシパル経由でも使えるため、頻用するなら最初に頑張って設定してしまえばそっちのほうが楽かもしれない。

```js
import { Client } from 'npm:@microsoft/microsoft-graph-client@3.0.4'

const ACCESS_TOKEN = 'xxxxxxxx'
const DRIVE_ID = 'aaaaaaaa'
const DIRECTORY_ITEM_ID = 'bbbbbbbb'
const IMAGE_WIDTH = 1024
const client = Client.init({ authProvider: done => done(null, ACCESS_TOKEN) })

const imageIds = await client.api(`/drives/${DRIVE_ID}/items/${DIRECTORY_ITEM_ID}/children`).top(500).select('id').get()
const thumbnails = await Promise.all(imageIds.value.map(({ id }) => {
  return client.api(`/drives/${DRIVE_ID}/items/${id}/thumbnails?select=c999999x${IMAGE_WIDTH}`).get()
    .then(({ value }) => Object.values(value[0])[0].url)
}))
console.log(thumbnails.map((url, idx) => `![${idx}](${url})`).join('\n'))
```

最初に特定のディレクトリ中にあるファイルを全てとりだし、次のリクエストでディメンションを指定したサムネ画像を生成している。OneDrive APIはわかりにくいが思いのほか強力で、案外なんでもできる。サムネイルの生成も縦横比を変えないまま任意の大きさに縮小できたりトリミングできたりするし、WordファイルをPDFにするみたいな変換処理やファイルのバージョン管理まで実装されているので、うまく使えばリッチなWebサービス制作にも活用できそうだ。

denoでnpmを使えるようになったのでこういう雑なスクリプトを`package.json`とか`node_modules`とかの邪魔なものをごちゃごちゃと一緒に配置しなくてよくなり嬉しい。
